<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login and Register</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='login_style.css') }}">
    <!-- Firebase SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="title">
            BeatBall.i 
            <span class="icon">
                <img src="{{ url_for('static', filename='ball.png') }}" alt="Soccer Ball" class="ball">
            </span>
        </h1>

        <div class="buttons">
            <!-- NÃºt Login -->
            <div class="form-wrapper">
                <button class="btn" id="login-btn">Login</button>
                <form class="form-popup" id="login-form" style="display: none;" method="POST">
                    <input type="text" placeholder="Username" id="login-username" class="input-field" name="username">
                    <input type="password" placeholder="Password" id="login-password" class="input-field" name="password">
                    <button type="submit" class="btn submit-btn">Submit</button>
                </form>
            </div>

            <!-- NÃºt Register -->
            <div class="form-wrapper">
                <button class="btn" id="register-btn">Register</button>
                <form class="form-popup" id="register-form" style="display: none;">
                    <input type="text" placeholder="Username" id="register-username" class="input-field">
                    <input type="email" placeholder="Email" id="register-email" class="input-field">
                    <input type="password" placeholder="Password" id="register-password" class="input-field">
                    <button type="submit" class="btn submit-btn">Register</button>
                </form>
            </div>
        </div>

        <p class="alternative-text">
            Or you can register or login with <span class="emoji">ðŸ“§</span>
        </p>

        <a href="#" class="forgot-password"><strong>Forgot Password?</strong></a>
    </div>

    <!-- JavaScript -->
    <script type="module">
        let inactivityTimeout;
        const logoutWarningTime = 4 * 60 * 1000; // 4 phÃºt (Ä‘á»ƒ cáº£nh bÃ¡o trÆ°á»›c)

        function resetInactivityTimer() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                alert("You will be logged out due to inactivity.");
                window.location.href = "/logout";
            }, logoutWarningTime);
        }

        // Reset timer khi ngÆ°á»i dÃ¹ng tÆ°Æ¡ng tÃ¡c
        document.addEventListener("mousemove", resetInactivityTimer);
        document.addEventListener("keypress", resetInactivityTimer);

        // Khá»Ÿi Ä‘á»™ng timer khi táº£i trang
        resetInactivityTimer();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getDatabase, ref, set, get, child, push} from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAnLivuERcg2mUavvq5T_x94DdKRwlcWBg",
            authDomain: "beatball-18492.firebaseapp.com",
            databaseURL: "https://beatball-18492-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "beatball-18492",
            storageBucket: "beatball-18492.firebasestorage.app",
            messagingSenderId: "35306778162",
            appId: "1:35306778162:web:42080ca10631dabf56562b",
            measurementId: "G-61Y7JC5TF7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const loginForm = document.getElementById('login-form');
        const registerBtn = document.getElementById('register-btn');
        const registerForm = document.getElementById('register-form');

        // Hiá»ƒn thá»‹ form vÃ  áº©n form cÃ²n láº¡i
        function toggleForm(formToShow, formToHide) {
            formToShow.style.display = 'block'; // Hiá»ƒn thá»‹ form
            formToHide.style.display = 'none';  // áº¨n form cÃ²n láº¡i
        }

        // Sá»± kiá»‡n click cho nÃºt Login
        loginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation(); // NgÄƒn sá»± kiá»‡n lan ra ngoÃ i
            toggleForm(loginForm, registerForm);
        });

        // Sá»± kiá»‡n click cho nÃºt Register
        registerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleForm(registerForm, loginForm);
        });

        // áº¨n form khi click ra ngoÃ i vÃ¹ng form
        document.addEventListener('click', (e) => {
            if (!loginForm.contains(e.target) && e.target !== loginBtn) {
                loginForm.style.display = 'none';
            }
            if (!registerForm.contains(e.target) && e.target !== registerBtn) {
                registerForm.style.display = 'none';
            }
        });

        // NgÄƒn form bá»‹ áº©n khi click vÃ o bÃªn trong form
        loginForm.addEventListener('click', (e) => e.stopPropagation());
        registerForm.addEventListener('click', (e) => e.stopPropagation());

        // Äáº£m báº£o form váº«n hiá»ƒn thá»‹ náº¿u ngÆ°á»i dÃ¹ng click vÃ o nÃºt nhÆ°ng form Ä‘Ã£ bá»‹ áº©n
        loginBtn.addEventListener('click', (e) => {
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            }
        });

        registerBtn.addEventListener('click', (e) => {
            if (registerForm.style.display === 'none') {
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
            }
        });

        // Xá»­ lÃ½ Register Form
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();  // Ngá»«ng hÃ nh Ä‘á»™ng máº·c Ä‘á»‹nh cá»§a form (submit)
        
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
        
            // Kiá»ƒm tra náº¿u táº¥t cáº£ cÃ¡c trÆ°á»ng Ä‘á»u cÃ³ giÃ¡ trá»‹
            if (username && email && password) {
                // Tham chiáº¿u Ä‘áº¿n node 'users' trong Firebase
                const usersRef = ref(database, 'users');
        
                // Kiá»ƒm tra náº¿u username Ä‘Ã£ tá»“n táº¡i
                get(usersRef).then((snapshot) => {
                    let usernameExists = false;
                    let emailExists = false;
        
                    if (snapshot.exists()) {
                        const usersData = snapshot.val();
        
                        // Kiá»ƒm tra náº¿u username Ä‘Ã£ tá»“n táº¡i
                        for (let userId in usersData) {
                            const user = usersData[userId];
                            if (user.username === username) {
                                usernameExists = true;
                            }
                            if (user.email === email) {
                                emailExists = true;
                            }
                        }
                    }
        
                    if (usernameExists) {
                        alert("Username already exists. Please choose another one.");
                    } else if (emailExists) {
                        alert("Email already exists. Please use another email.");
                    } else {
                        // Táº¡o khÃ³a ngáº«u nhiÃªn cho ngÆ°á»i dÃ¹ng má»›i
                        const newUserRef = push(usersRef);
        
                        // Dá»¯ liá»‡u ngÆ°á»i dÃ¹ng vá»›i cÃ¡c cá»™t máº·c Ä‘á»‹nh
                        const userData = {
                            username: username,
                            email: email,
                            password: password,
                            point: 1000,  // Äiá»ƒm máº·c Ä‘á»‹nh lÃ  1000
                            createdAt: new Date().toISOString(),  // Thá»i gian táº¡o tÃ i khoáº£n
                            lastLogin: new Date().toISOString(),  // Thá»i gian Ä‘Äƒng nháº­p láº§n cuá»‘i
                            isActive: true,  // NgÆ°á»i dÃ¹ng cÃ³ hoáº¡t Ä‘á»™ng hay khÃ´ng
                            profilePicture: "",  // Cá»™t máº·c Ä‘á»‹nh cho áº£nh Ä‘áº¡i diá»‡n
                            role: "user",  // Cá»™t máº·c Ä‘á»‹nh cho vai trÃ² ngÆ°á»i dÃ¹ng
                        };
        
                        // LÆ°u thÃ´ng tin ngÆ°á»i dÃ¹ng vÃ o Firebase dÆ°á»›i khÃ³a ngáº«u nhiÃªn
                        set(newUserRef, userData).then(() => {
                            alert("Registration successful!");
                            window.location.href = "/home"; // Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n trang home
                        }).catch((error) => {
                            console.error("Error saving to Firebase:", error);
                            alert("An error occurred. Please try again.");
                        });
                    }
                }).catch((error) => {
                    console.error("Error checking users:", error);
                    alert("An error occurred while checking the users.");
                });
            } else {
                alert("Please fill in all fields.");
            }
        });        

        // Xá»­ lÃ½ Login Form
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();  // NgÄƒn hÃ nh Ä‘á»™ng máº·c Ä‘á»‹nh cá»§a form
    
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
    
            if (username && password) {
                const usersRef = ref(database, 'users');
    
                get(usersRef).then((snapshot) => {
                    let userFound = false;
                    let correctPassword = false;
                    let userId = null;
    
                    if (snapshot.exists()) {
                        const usersData = snapshot.val();
    
                        for (let id in usersData) {
                            const user = usersData[id];
                            if (user.username === username) {
                                userFound = true;
                                if (user.password === password) {
                                    correctPassword = true;
                                    userId = id;
                                    break;
                                }
                            }
                        }
    
                        if (userFound && correctPassword) {
                            // Gá»­i yÃªu cáº§u POST tá»›i server
                            fetch('/login', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    username: username,
                                    user_id: userId
                                })
                            }).then(response => {
                                if (response.redirected) {
                                    window.location.href = response.url;
                                } else {
                                    response.text().then(alert);
                                }
                            }).catch(err => {
                                console.error("Error during server communication:", err);
                                alert("Error during login. Please try again.");
                            });
                        } else if (userFound) {
                            alert("Incorrect password. Please try again.");
                        } else {
                            alert("Username not found. Please register first.");
                        }
                    } else {
                        alert("Error retrieving user data.");
                    }
                }).catch((error) => {
                    console.error("Firebase error:", error);
                    alert("Error checking user data.");
                });
            } else {
                alert("Please fill in all fields.");
            }
        });    
    </script>
</body>
</html>
