<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login and Register</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='login_style.css') }}">
    <!-- Firebase SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <!-- Google Sign-In SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="../static/crypto-js.min.js"></script>
</head>
<body>
    <!-- N√∫t Back ·ªü g√≥c tr√°i tr√™n c√πng -->
    <div class="back-icon-container">
        <a href="/" id="back-button">
            <img src="{{ url_for('static', filename='back-icon.png') }}" alt="Back" class="back-icon">
        </a>
    </div>

    <div class="container">
        <h1 class="title">
            BeatBall.i 
            <span class="icon">
                <img src="{{ url_for('static', filename='ball.png') }}" alt="Soccer Ball" class="ball">
            </span>
        </h1>

        <div class="buttons">
            <!-- N√∫t Login -->
            <div class="form-wrapper">
                <button class="btn" id="login-btn">Login</button>
                <form class="form-popup" id="login-form" style="display: none;" method="POST">
                    <input type="text" placeholder="Username" id="login-username" class="input-field" name="username">
                    <input type="password" placeholder="Password" id="login-password" class="input-field" name="password">
                    <button type="submit" class="btn submit-btn">Submit</button>
                </form>
            </div>

            <!-- N√∫t Register -->
            <div class="form-wrapper">
                <button class="btn" id="register-btn">Register</button>
                <form class="form-popup" id="register-form" style="display: none;">
                    <input type="text" placeholder="Username" id="register-username" class="input-field">
                    <input type="email" placeholder="Email" id="register-email" class="input-field">
                    <input type="password" placeholder="Password" id="register-password" class="input-field">
                    <button type="submit" class="btn submit-btn">Register</button>
                </form>
            </div>
        </div>

        <p class="alternative-text">
            Or you can register or login with 
            <span class="emoji email-icon" id="google-login-icon">üìß</span>
        </p>        

        <a href="#" class="forgot-password" id="forgot-password-link"><strong>Forgot Password?</strong></a>

        <!-- Th√™m overlay -->
        <div id="overlay" class="overlay"></div>

        <!-- Form Forgot Password -->
        <div id="forgot-password-form" class="form-popup">
            <button type="button" class="close-btn" onclick="closeForgotPasswordForm()">&times;</button>
            <h2 style="margin-bottom: 20px;">Forgot Password</h2>
            <form id="resetPasswordForm">
                <input type="email" class="input-field" placeholder="Enter your email" required>
                <button type="submit" class="submit-btn">Reset Password</button>
            </form>
        </div>       
    </div>

    <!-- JavaScript -->
    <script type="module">
        const backButton = document.getElementById("back-button");
        backButton.addEventListener("click", (e) => {
            e.preventDefault(); // NgƒÉn h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh
            window.location.href = "/"; // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang /
        });

        //
        let inactivityTimeout;
        const logoutWarningTime = 4 * 60 * 1000; // 4 ph√∫t (ƒë·ªÉ c·∫£nh b√°o tr∆∞·ªõc)

        function resetInactivityTimer() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                alert("You will be logged out due to inactivity.");
                window.location.href = "/logout";
            }, logoutWarningTime);
        }

        // Reset timer khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c
        document.addEventListener("mousemove", resetInactivityTimer);
        document.addEventListener("keypress", resetInactivityTimer);

        // Kh·ªüi ƒë·ªông timer khi t·∫£i trang
        resetInactivityTimer();

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getDatabase, ref, set, get, child, push} from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAnLivuERcg2mUavvq5T_x94DdKRwlcWBg",
            authDomain: "beatball-18492.firebaseapp.com",
            databaseURL: "https://beatball-18492-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "beatball-18492",
            storageBucket: "beatball-18492.firebasestorage.app",
            messagingSenderId: "35306778162",
            appId: "1:35306778162:web:42080ca10631dabf56562b",
            measurementId: "G-61Y7JC5TF7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM Elements
        const loginBtn = document.getElementById('login-btn');
        const loginForm = document.getElementById('login-form');
        const registerBtn = document.getElementById('register-btn');
        const registerForm = document.getElementById('register-form');

        // Hi·ªÉn th·ªã form v√† ·∫©n form c√≤n l·∫°i
        function toggleForm(formToShow, formToHide) {
            formToShow.style.display = 'block'; // Hi·ªÉn th·ªã form
            formToHide.style.display = 'none';  // ·∫®n form c√≤n l·∫°i
        }

        // S·ª± ki·ªán click cho n√∫t Login
        loginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation(); // NgƒÉn s·ª± ki·ªán lan ra ngo√†i
            toggleForm(loginForm, registerForm);
        });

        // S·ª± ki·ªán click cho n√∫t Register
        registerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleForm(registerForm, loginForm);
        });

        // ·∫®n form khi click ra ngo√†i v√πng form
        document.addEventListener('click', (e) => {
            if (!loginForm.contains(e.target) && e.target !== loginBtn) {
                loginForm.style.display = 'none';
            }
            if (!registerForm.contains(e.target) && e.target !== registerBtn) {
                registerForm.style.display = 'none';
            }
        });

        // NgƒÉn form b·ªã ·∫©n khi click v√†o b√™n trong form
        loginForm.addEventListener('click', (e) => e.stopPropagation());
        registerForm.addEventListener('click', (e) => e.stopPropagation());

        // ƒê·∫£m b·∫£o form v·∫´n hi·ªÉn th·ªã n·∫øu ng∆∞·ªùi d√πng click v√†o n√∫t nh∆∞ng form ƒë√£ b·ªã ·∫©n
        loginBtn.addEventListener('click', (e) => {
            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            }
        });

        registerBtn.addEventListener('click', (e) => {
            if (registerForm.style.display === 'none') {
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
            }
        });

        async function validateEmail(email) {
            try {
                const response = await fetch(`https://emailvalidation.abstractapi.com/v1/?api_key=19e711b3ffc9421590f77650d28e4365&email=${email}`);
                const data = await response.json();
                return data.deliverability === 'DELIVERABLE'; // Tr·∫£ v·ªÅ true n·∫øu email t·ªìn t·∫°i
            } catch (error) {
                console.error("Error validating email:", error);
                return false;
            }
        }
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // NgƒÉn h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa form
        
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
        
            if (username && email && password) {
                try {
                    // Ki·ªÉm tra email c√≥ h·ª£p l·ªá kh√¥ng
                    const emailValid = await validateEmail(email);
                    if (!emailValid) {
                        alert("The email address is not valid. Please use a real email.");
                        return;
                    }
        
                    // Ki·ªÉm tra xem username v√† email c√≥ t·ªìn t·∫°i trong Firebase
                    const usersRef = ref(database, 'users');
                    const snapshot = await get(usersRef);
        
                    let usernameExists = false;
                    let emailExists = false;
        
                    if (snapshot.exists()) {
                        const usersData = snapshot.val();
                        for (let userId in usersData) {
                            const user = usersData[userId];
                            if (user.username === username) {
                                usernameExists = true;
                            }
                            if (user.email === email) {
                                emailExists = true;
                            }
                        }
                    }
        
                    if (usernameExists) {
                        alert("Username already exists. Please choose another one.");
                        return;
                    } else if (emailExists) {
                        alert("Email already exists. Please use another email.");
                        return;
                    } else {
                        // T·∫°o kh√≥a ng·∫´u nhi√™n cho ng∆∞·ªùi d√πng m·ªõi
                        const newUserRef = push(usersRef);
        
                        // BƒÉm m·∫≠t kh·∫©u b·∫±ng Crypto-JS (SHA256)
                        const hashedPassword = CryptoJS.SHA256(password).toString();
        
                        // D·ªØ li·ªáu ng∆∞·ªùi d√πng v·ªõi c√°c c·ªôt m·∫∑c ƒë·ªãnh
                        const userData = {
                            username: username,
                            email: email,
                            password: hashedPassword,
                            createdAt: new Date().toISOString(),
                            lastLogin: new Date().toISOString(),
                            isActive: true,
                            profilePicture: "/static/images/default-avatar.png",
                            role: "user",
                            stats: {
                                point: 1000,
                                matches: 0,
                                win_matches: 0,
                                goals: 0,
                                assists: 0,
                                rating_change: 0,
                            },
                        };
        
                        // L∆∞u th√¥ng tin ng∆∞·ªùi d√πng v√†o Firebase d∆∞·ªõi kh√≥a ng·∫´u nhi√™n
                        await set(newUserRef, userData);
        
                        // G·ª≠i request ƒë·∫øn route register ƒë·ªÉ t·∫°o session
                        const response = await fetch('/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: username,
                                user_id: newUserRef.key,
                            }),
                        });
        
                        const data = await response.json();
                        if (data.success) {
                            alert("Registration successful!");
                            window.location.href = data.redirect;
                        } else {
                            throw new Error(data.error);
                        }
                    }
                } catch (error) {
                    console.error("Error during registration:", error);
                    alert("An error occurred. Please try again.");
                }
            } else {
                alert("Please fill in all fields.");
            }
        });                        

        // X·ª≠ l√Ω Login Form
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // NgƒÉn h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa form
        
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
        
            if (username && password) {
                const usersRef = ref(database, 'users');
        
                try {
                    const snapshot = await get(usersRef);
                    let userFound = false;
                    let userId = null;
        
                    if (snapshot.exists()) {
                        const usersData = snapshot.val();
        
                        // T√¨m ng∆∞·ªùi d√πng trong Firebase
                        for (let id in usersData) {
                            const user = usersData[id];
                            if (user.username === username) {
                                userFound = true;
                                userId = id;
        
                                // So s√°nh m·∫≠t kh·∫©u ƒë√£ bƒÉm
                                const hashedInputPassword = CryptoJS.SHA256(password).toString();
                                if (hashedInputPassword === user.password) {
                                    // M·∫≠t kh·∫©u ƒë√∫ng, g·ª≠i y√™u c·∫ßu POST t·ªõi server
                                    const response = await fetch('/login', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            username: username,
                                            user_id: userId,
                                        }),
                                    });
        
                                    if (response.redirected) {
                                        window.location.href = response.url;
                                    } else {
                                        const responseText = await response.text();
                                        alert(responseText);
                                    }
                                } else {
                                    alert("Incorrect password. Please try again.");
                                }
        
                                break; // Tho√°t v√≤ng l·∫∑p khi t√¨m th·∫•y ng∆∞·ªùi d√πng
                            }
                        }
                    }
        
                    if (!userFound) {
                        alert("Username not found. Please register first.");
                    }
                } catch (error) {
                    console.error("Error during login:", error);
                    alert("An error occurred during login. Please try again.");
                }
            } else {
                alert("Please fill in all fields.");
            }
        });

        //
        document.getElementById("google-login-icon").addEventListener("click", () => {
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=code&client_id=35306778162-6i3q4jiron35lefs2t03fi82vd3i23or.apps.googleusercontent.com&redirect_uri=https://beatball.onrender.com/google-login&scope=email profile openid&prompt=consent`;
            window.location.href = authUrl;
        });
        
        //        
        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const overlay = document.getElementById('overlay');
        const closeBtn = document.querySelector('.close-btn');
        const forgotPasswordLink = document.querySelector('.forgot-password');

        // H√†m m·ªü form
        function showForgotPasswordForm() {
            forgotPasswordForm.style.display = 'block';
            overlay.style.display = 'block';
        }

        // H√†m ƒë√≥ng form
        function closeForgotPasswordForm() {
            forgotPasswordForm.style.display = 'none';
            overlay.style.display = 'none';
            // X√≥a n·ªôi dung trong √¥ nh·∫≠p email
            const emailInput = forgotPasswordForm.querySelector('input[type="email"]');
            if (emailInput) {
                emailInput.value = ''; // ƒê·∫∑t gi√° tr·ªã √¥ nh·∫≠p email v·ªÅ chu·ªói r·ªóng
            }
        }

        // S·ª± ki·ªán click v√†o link Forgot Password
        forgotPasswordLink.addEventListener('click', function(e) {
            e.preventDefault();
            showForgotPasswordForm();
        });

        // S·ª± ki·ªán click v√†o n√∫t ƒë√≥ng
        closeBtn.addEventListener('click', closeForgotPasswordForm);

        // S·ª± ki·ªán click v√†o overlay (b√™n ngo√†i form)
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                closeForgotPasswordForm();
            }
        });

        // ƒê√≥ng form khi nh·∫•n ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeForgotPasswordForm();
            }
        });

        // S·ª± ki·ªán submit form
        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = this.querySelector('input[type="email"]').value.trim();
        
            if (!email) {
                alert("Please enter your email.");
                return;
            }
        
            try {
                const response = await fetch('/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email }),
                });
        
                const result = await response.json();
        
                if (response.ok && result.success) {
                    alert(result.message || 'Reset password link has been sent to your email!');
                    closeForgotPasswordForm();
                } else {
                    alert(result.error || 'Failed to reset password.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again later.');
            }
        });                
    </script>
</body>
</html>
