<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Players Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='room_4_style.css') }}">
    <script src="https://cdn.socket.io/4.1.3/socket.io.min.js"></script>
</head>
<body>
    <!-- Ký hiệu quay lại ở góc trái trên cùng -->
    <div class="back-button">
        <a href="{{ url_for('home') }}">
            <img src="{{ url_for('static', filename='back-icon.png') }}" alt="Back" class="back-icon">
        </a>
    </div>

    <div class="container">
        <!-- Phần card player với chữ VS ở giữa, tất cả trên một hàng -->
        <div class="player-cards">
            <div class="player-card">
                <div class="avatar"></div>
                <p class="player-name">Player 1</p>
                <p class="player-score">1000</p>
            </div>
            <div class="player-card">
                <div class="avatar"></div>
                <p class="player-name">Player 2</p>
                <p class="player-score">1200</p>
            </div>

            <!-- Chữ VS ở giữa -->
            <div class="vs-divider">
                <img src="{{ url_for('static', filename='vs-icon.png') }}" alt="VS" class="vs-icon">
            </div>

            <div class="player-card">
                <div class="avatar"></div>
                <p class="player-name">Player 3</p>
                <p class="player-score">900</p>
            </div>
            <div class="player-card">
                <div class="avatar"></div>
                <p class="player-name">Player 4</p>
                <p class="player-score">1100</p>
            </div>
        </div>
    </div>

    <!-- Room ID và Find Match nằm trên khung chat -->
    <div class="room-options">
        <div class="room-id">
            <span>Room ID:</span>
            <input type="text" value="{{ room_id }}" readonly>
        </div>
        <button class="find-match-btn" id="find-match-btn">Find Match</button>
    </div>
    
    <!-- Phần chat box -->
    <div class="chat-box">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Type a message..." />
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script>
        // Kết nối với server socket.io
        const socket = io(window.location.origin, {
            transports: ["websocket"], // Ưu tiên WebSocket          
            reconnection: true, // Tự động tái kết nối
            reconnectionAttempts: 5, // Số lần thử tái kết nối
            reconnectionDelay: 1000, // Thời gian chờ giữa mỗi lần thử tái kết nối
            timeout: 20000, // Thời gian chờ kết nối (ms)
        });

        // Lắng nghe sự kiện "receive_message" từ server và hiển thị tin nhắn
        socket.on("receive_message", function(data) {
            const chatMessages = document.getElementById("chat-messages");
    
            // Tạo thẻ div cho tin nhắn
            const messageElement = document.createElement("div");
            messageElement.classList.add("message");
    
            // Phân biệt tin nhắn của chính bạn và người khác
            const isOwnMessage = data.username === "{{ session.username }}";
            messageElement.classList.add(isOwnMessage ? "user" : "other");
    
            // Thêm username và tin nhắn
            const usernameElement = document.createElement("span");
            usernameElement.textContent = `${data.username}: `;
            usernameElement.classList.add("username");
    
            const textElement = document.createElement("span");
            textElement.textContent = data.message;
    
            // Gắn các phần tử vào khung tin nhắn
            messageElement.appendChild(usernameElement);
            messageElement.appendChild(textElement);
    
            chatMessages.appendChild(messageElement);
    
            // Tự động cuộn xuống cuối
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // Gửi tin nhắn khi người dùng nhấn nút gửi
        document.getElementById("send-btn").addEventListener("click", sendMessage);
        document.getElementById("chat-input").addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                sendMessage();
            }
        });

        function sendMessage() {
            const message = document.getElementById("chat-input").value.trim();
            if (message) {
                // Gửi tin nhắn qua socket
                socket.emit("send_message", { message: message });
                document.getElementById("chat-input").value = ""; // Xóa ô nhập
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const backButton = document.querySelector(".back-button a");
            const roomId = "{{ room_id }}";

            if (!history.state || history.state.page !== "room") {
                history.replaceState({ page: "room", roomId: currentRoomId }, "", window.location.href);
            }
        
            // Hàm xử lý rời phòng
            const handleLeaveRoom = async () => {
                try {
                    const response = await fetch(`/leave-room/${roomId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                    });
                    
                    if (response.ok) {
                        window.location.replace('/home');
                    } else {
                        console.error("Failed to leave room:", response.status);
                        // Vẫn chuyển về home nếu có lỗi để tránh user bị kẹt
                        window.location.replace('/home');
                    }
                } catch (error) {
                    console.error("Error leaving room:", error);
                    // Vẫn chuyển về home nếu có lỗi
                    window.location.replace('/home');
                }
            };
        
            // Xử lý khi click nút back
            backButton.addEventListener("click", (event) => {
                event.preventDefault();
                handleLeaveRoom();
            });
        
            // Xử lý khi bấm back-button của trình duyệt
            window.addEventListener("popstate", (event) => {
                event.preventDefault();
                handleLeaveRoom();
            });
        
            // Thêm state cho trang hiện tại
            if (history.state === null) {
                history.replaceState({ page: "room" }, "", window.location.href);
            }
        
            // Xử lý khi user đóng tab/window
            window.addEventListener("beforeunload", (event) => {
                fetch(`/leave-room/${roomId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // Using keepalive to ensure the request completes
                    keepalive: true
                });
            });
        
            // Nếu đang dùng Socket.IO, thêm xử lý disconnect
            if (typeof io !== 'undefined') {
                const socket = io();
                socket.on('disconnect', () => {
                    handleLeaveRoom();
                });
            }
        });

        // Chuyển sang trang Find Match với Flask
        document.getElementById("find-match-btn").addEventListener("click", () => {
            window.location.href = "{{ url_for('find_match') }}"; // Dùng Flask url_for để tạo URL động
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const currentRoomId = "{{ room_id }}";  // Lấy room_id từ Flask template
        const currentUsername = "{{ session.username }}";  // Lấy username từ session

        // Lắng nghe sự kiện người chơi rời phòng
        socket.on('player_left', function(data) {
            if (data.room_id === currentRoomId && data.username === currentUsername) {
                // Nếu chính người dùng này rời phòng ở tab khác
                alert("You have left the room in another tab.");
                window.location.href = "/home";
            }
        });

        // Lắng nghe sự kiện phòng bị xóa
        socket.on('room_deleted', function(data) {
            if (data.room_id === currentRoomId) {
                alert("The room has been closed.");
                window.location.href = "/home";
            }
        });

        // Xử lý khi người dùng rời trang
        window.addEventListener('beforeunload', function(e) {
            // Gửi request để rời phòng khi người dùng thoát trang
            fetch(`/leave-room/${roomId}`, {
                method: 'POST',
                keepalive: true // Đảm bảo request được gửi ngay cả khi trang đóng
            });
        });
    </script>
</body>
</html>
